<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: "Segoe WPC", "Segoe UI", "SFUIText-Light", "HelveticaNeue-Light", sans-serif, "Droid Sans Fallback";
	font-size: 14px;
	padding-left: 12px;
	line-height: 22px;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	color: #4080D0;
	text-decoration: none;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

a:hover {
	color: #4080D0;
	text-decoration: underline;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left: 5px solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 14px;
	line-height: 19px;
}

.mac code {
	font-size: 12px;
	line-height: 18px;
}

code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

/** Theming */

.vscode-light {
	color: rgb(30, 30, 30);
}

.vscode-dark {
	color: #DDD;
}

.vscode-high-contrast {
	color: white;
}

.vscode-light code {
	color: #A31515;
}

.vscode-dark code {
	color: #D7BA7D;
}

.vscode-light code > div {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark code > div {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast code > div {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

.vscode-light blockquote,
.vscode-dark blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.vscode-high-contrast blockquote {
	background: transparent;
	border-color: #fff;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	padding: 10px;
	overflow-wrap: break-word;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

:not(pre):not(.hljs) > code {
	color: #A31515;
	font-size: inherit;
	font-family: inherit;
}

</style>

<style>
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 13px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url("../../images/modules/styleguide/para.png") no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url("../../images/modules/pulls/dirty-shade.png") repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0; }

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }

ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

ul :last-child, ol :last-child {
  margin-bottom: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 11px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      text-align: left;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 11px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 10px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

</style>

</head>
<body>
<h1>ROS特訓</h1>
<h2>IPアドレスとネットワークについて理解しよう</h2>
<ul>
<li>ifconfigコマンド</li>
<li>ssh(telnet)コマンド</li>
<li>sftp(ftp)コマンド</li>
<li>vi,nanoコマンド</li>
</ul>
<h2>Pub/Sub型のデータ通信方法について理解する（MQTT）</h2>
<h3>MQTTとは</h3>
<p>MQTTでのデータ通信はPublish/Subscriber型のメッセージングによって行われます．
情報の送信者のことをPublisher，情報の受信者のことをSubscriberと呼んでいます．
両者はトピックと呼ばれる関心事の名前を共有し，Publisherはトピックを指定してメッセージを送信し，
Subscriberはトピックからメッセージを受け取ります．</p>
<p>PublisherとSubscriberのメッセージの伝達には，仲介者（MQTTではブローカーと呼ばれます）
が両者の間を取り持つことで成立しています．
すると，情報を受け取るSubscriberは、最初にトピックにSubScribeすると、
その後はただ待っているだけで、そのトピックに情報の更新があるたびに、メッセージを受け取ることができます．
なので，ポーリングによって，定期的にデータが来ているかを監視する必要がないため，
非同期システムを比較的簡単に構築することができることが非常に大きなメリットといえます．</p>
<p>メッセージの送信者であるPublisherと，送信先であるSubscriberとの間にMQTTブローカーが仲介することによって，
PublisherはSubscriberの存在を強く意識することなく，メッセージを送信することができるため，
プログラムの設計者は，外部システムとの入出力関係だけに注目すれば良くなることから，
ロボット開発（特にチーム開発）において非常に強力な武器であると言えます．実際，後述するロボット開発者向けミドルウェアである
ROS（RobotOperatingSystem）においても，このPub/Sub型のメッセージングシステムが採用されています．</p>
<p>ここでは，MQTTを使いながら，Pub/Sub型のメッセージングを使ったネットワーク通信のプログラミングを
実際に試しながら慣れていきましょう．</p>
<h3>mosquittoとは</h3>
<p><a href="https://mosquitto.org/">mosquitto</a>とは，通信規格であるMQTTを実装したオープンソースライブラリであり，
これを使うことを簡単にMQTTブローカーをネットワーク上に構築することができます．</p>
<p>インストールの際は，Ubuntu標準リポジトリのmosquittoが古いものしか無いようなので，リポジトリを追加します．</p>
<pre><code>sudo add-apt-repository ppa:mosquitto-dev/mosquitto-ppa
sudo apt-get update
sudo apt-get install mosquitto 
</code></pre>
<h3>pythonでMQTTクライアントを作成する</h3>
<p>PythonでMQTTクライアント,つまりPublisherやSubscriberを実装したい場合，
<a href="https://eclipse.org/paho/">paho-mqtt</a>を使うといいでしょう．</p>
<p>以後，想定する実行環境はUbuntu 14.04とします．</p>
<p>Pythonで外部ライブラリを使いたい場合，pipと呼ばれるツールがよく用いられます．
ev3devの推奨環境がPython3なので，ここではpip3でpaho-mqttをインストールすることにします．</p>
<pre><code>sudo pip3 install paho-mqtt
</code></pre>
<p>なお，pip3が入ってない場合は，</p>
<pre><code>sudo apt-get install python3-pip
</code></pre>
<p>でインストールしておいてください．</p>
<p>これで準備完了です．テキストエディタもしくは，vim等のエディタを開いて，プログラムを書いていきましょう．
なお，説明の都合上サンプルのプログラムをここに書いていますが，最初のうちはできればコピペせず，
実際にキーボードを叩きながら覚えることを推奨します．</p>
<h3>Subscriberを作成</h3>
<pre class="hljs"><code>
    <span class="hljs-comment">#!/usr/bin/env python</span>
    <span class="hljs-comment"># -*- coding:utf-8 -*-</span>


    <span class="hljs-keyword">import</span> paho.mqtt.client <span class="hljs-keyword">as</span> mqtt

    <span class="hljs-comment"># ブローカーの設定</span>
    host = <span class="hljs-string">'127.0.0.1'</span>
    port = <span class="hljs-number">1883</span>

    FORWARD_TOPIC = <span class="hljs-string">'ev3/forward'</span>
    BACK_TOPIC = <span class="hljs-string">'ev3/back'</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_connect</span><span class="hljs-params">(client, userdata, flags, respons_code)</span>:</span>
        print(<span class="hljs-string">'status {0}'</span>.format(respons_code))

        client.subscribe(FORWARD_TOPIC) <span class="hljs-comment"># topic名を指定</span>
        client.subscribe(BACK_TOPIC) <span class="hljs-comment"># topic名を指定</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_message</span><span class="hljs-params">(client, userdata, msg)</span>:</span>
        print(msg.topic + <span class="hljs-string">' '</span> + str(msg.payload))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_foward</span><span class="hljs-params">(client, userdata, msg)</span>:</span>
        print(<span class="hljs-string">"foward: "</span> + str(msg.payload))

        <span class="hljs-comment"># ここにforwardトピックを受け取った時の処理を書く</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_back</span><span class="hljs-params">(client, userdata, msg)</span>:</span>
        print(<span class="hljs-string">"back : "</span> + str(msg.payload))

        <span class="hljs-comment"># ここにbackトピックを受け取ったときの処理を書く</span>


    <span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:

        <span class="hljs-keyword">try</span> : 
            <span class="hljs-comment"># mqttクライアントの生成</span>
            client = mqtt.Client()

            <span class="hljs-comment">## コールバックを登録する</span>
            <span class="hljs-comment"># 接続時に実行される処理</span>
            client.on_connect = on_connect
            <span class="hljs-comment"># 何かしらのメッセージを受け取ったとき</span>
            client.on_message = on_message

            <span class="hljs-comment"># 各トピックに対するコールバック</span>
            client.message_callback_add(FORWARD_TOPIC, on_foward)
            client.message_callback_add(BACK_TOPIC, on_back)

            client.connect(host, port=port, keepalive=<span class="hljs-number">60</span>)

            <span class="hljs-comment"># 待ち受け状態にする</span>
            client.loop_forever()

        <span class="hljs-keyword">except</span> KeyboardInterrupt  :
            <span class="hljs-keyword">print</span> ( <span class="hljs-string">"KeyboardInterrupt\n"</span> )
            client.disconnect()
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-keyword">print</span> (<span class="hljs-string">"process end"</span>)

</code></pre>
<h4>練習問題:</h4>
<p>次の仕様を満たすロボットを作成せよ．</p>
<p>要求1:
トピック'ev3/vel'を受け取り，機体の並進方向の移動スピード(vel)を変更できる．</p>
<p>要求2:
トピック'ev3/steer'を受け取り，機体の操舵角指令(steer)を受け取ることができる．</p>
<p>ただし，steerの有効範囲は-15 &lt; steer &lt; 15 とし，</p>
<pre><code>steer = 15 (steer &gt; 15)
steer = ev3/steer が示す値(msg.payload)
stter = -15 (steer &lt; -15)
</code></pre>
<p>要求3:
左右のモータ出力(motorL,motorR)は</p>
<pre><code>motorR = vel + steer
motorL = vel - steer
</code></pre>
<p>とする．ただし，-15 &lt; vel &lt; 15 のときは，</p>
<pre><code>vel = 0
</code></pre>
<p>とする</p>
<h3>センサデータを送信するPublisherを作成する</h3>
<p>メッセージをネットワーク上にPublishしたいときは，</p>
<pre><code>client.publish(topicname, message)
</code></pre>
<p>で送信します．topicnameとmessageは文字列形式で渡します．</p>
<p>サンプルプログラム</p>
<pre class="hljs"><code>
<span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># -*- coding: utf-8 -*-</span>

<span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep
<span class="hljs-keyword">import</span> paho.mqtt.client <span class="hljs-keyword">as</span> mqtt

<span class="hljs-comment"># MQTTブローカーのアドレスとポートを指定する</span>
host = <span class="hljs-string">'192.168.11.11'</span>
port = <span class="hljs-number">1883</span>

<span class="hljs-comment"># インスタンスの生成</span>
client = mqtt.Client()
client.connect(host, port=port, keepalive=<span class="hljs-number">60</span>)

<span class="hljs-comment"># topicの発行</span>
topic = <span class="hljs-string">'test'</span>
client.publish(topic, <span class="hljs-string">'message'</span>)
sleep(<span class="hljs-number">0.2</span>)

<span class="hljs-comment"># ブローカーと切断する</span>
client.disconnect()
</code></pre>
<h4>練習問題:</h4>
<p>EV3超音波センサーのデータを周期10HzでPublishせよ．</p>
<h3>PCとEV3をMQTTで通信させよう</h3>
<h2>ROSについて理解しよう</h2>
<h3>Pub/Sub型のメッセージング</h3>
<p>http://wiki.ros.org/ja/indigo/Installation/Ubuntu</p>
<h3>ROSのインストール</h3>
<p>http://wiki.ros.org/ja/indigo/Installation/Ubuntu</p>
<h3>自分のパッケージを作成する</h3>
<h2>他の人が書いたパッケージと連携しよう</h2>
<ul>
<li>joy_teleop</li>
</ul>
<h2>OpenCVを使って画像処理をしよう</h2>
<ul>
<li>OpenCVを使う</li>
</ul>

</body>
</html>
